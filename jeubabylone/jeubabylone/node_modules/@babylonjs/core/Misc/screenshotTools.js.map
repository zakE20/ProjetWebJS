{"version":3,"file":"screenshotTools.js","sourceRoot":"","sources":["../../../sourceES6/core/Misc/screenshotTools.ts"],"names":[],"mappings":"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","sourcesContent":["import { Nullable } from \"../types\";\r\nimport { Camera } from \"../Cameras/camera\";\r\nimport { Texture } from \"../Materials/Textures/texture\";\r\nimport { RenderTargetTexture } from \"../Materials/Textures/renderTargetTexture\";\r\nimport { FxaaPostProcess } from \"../PostProcesses/fxaaPostProcess\";\r\nimport { Constants } from \"../Engines/constants\";\r\nimport { Logger } from \"./logger\";\r\nimport { _TypeStore } from \"./typeStore\";\r\nimport { Tools } from './tools';\r\n\r\ndeclare type Engine = import(\"../Engines/engine\").Engine;\r\n\r\n/**\r\n * Class containing a set of static utilities functions for screenshots\r\n */\r\nexport class ScreenshotTools {\r\n    /**\r\n     * Captures a screenshot of the current rendering\r\n     * @see http://doc.babylonjs.com/how_to/render_scene_on_a_png\r\n     * @param engine defines the rendering engine\r\n     * @param camera defines the source camera\r\n     * @param size This parameter can be set to a single number or to an object with the\r\n     * following (optional) properties: precision, width, height. If a single number is passed,\r\n     * it will be used for both width and height. If an object is passed, the screenshot size\r\n     * will be derived from the parameters. The precision property is a multiplier allowing\r\n     * rendering at a higher or lower resolution\r\n     * @param successCallback defines the callback receives a single parameter which contains the\r\n     * screenshot as a string of base64-encoded characters. This string can be assigned to the\r\n     * src parameter of an <img> to display it\r\n     * @param mimeType defines the MIME type of the screenshot image (default: image/png).\r\n     * Check your browser for supported MIME types\r\n     */\r\n    public static CreateScreenshot(engine: Engine, camera: Camera, size: any, successCallback?: (data: string) => void, mimeType: string = \"image/png\"): void {\r\n        var width: number;\r\n        var height: number;\r\n\r\n        // If a precision value is specified\r\n        if (size.precision) {\r\n            width = Math.round(engine.getRenderWidth() * size.precision);\r\n            height = Math.round(width / engine.getAspectRatio(camera));\r\n        }\r\n        else if (size.width && size.height) {\r\n            width = size.width;\r\n            height = size.height;\r\n        }\r\n        //If passing only width, computing height to keep display canvas ratio.\r\n        else if (size.width && !size.height) {\r\n            width = size.width;\r\n            height = Math.round(width / engine.getAspectRatio(camera));\r\n        }\r\n        //If passing only height, computing width to keep display canvas ratio.\r\n        else if (size.height && !size.width) {\r\n            height = size.height;\r\n            width = Math.round(height * engine.getAspectRatio(camera));\r\n        }\r\n        //Assuming here that \"size\" parameter is a number\r\n        else if (!isNaN(size)) {\r\n            height = size;\r\n            width = size;\r\n        }\r\n        else {\r\n            Logger.Error(\"Invalid 'size' parameter !\");\r\n            return;\r\n        }\r\n\r\n        if (!Tools._ScreenshotCanvas) {\r\n            Tools._ScreenshotCanvas = document.createElement('canvas');\r\n        }\r\n\r\n        Tools._ScreenshotCanvas.width = width;\r\n        Tools._ScreenshotCanvas.height = height;\r\n\r\n        var renderContext = Tools._ScreenshotCanvas.getContext(\"2d\");\r\n\r\n        var ratio = engine.getRenderWidth() / engine.getRenderHeight();\r\n        var newWidth = width;\r\n        var newHeight = newWidth / ratio;\r\n        if (newHeight > height) {\r\n            newHeight = height;\r\n            newWidth = newHeight * ratio;\r\n        }\r\n\r\n        var offsetX = Math.max(0, width - newWidth) / 2;\r\n        var offsetY = Math.max(0, height - newHeight) / 2;\r\n\r\n        var renderingCanvas = engine.getRenderingCanvas();\r\n        if (renderContext && renderingCanvas) {\r\n            renderContext.drawImage(renderingCanvas, offsetX, offsetY, newWidth, newHeight);\r\n        }\r\n\r\n        Tools.EncodeScreenshotCanvasData(successCallback, mimeType);\r\n    }\r\n\r\n    /**\r\n     * Generates an image screenshot from the specified camera.\r\n     * @see http://doc.babylonjs.com/how_to/render_scene_on_a_png\r\n     * @param engine The engine to use for rendering\r\n     * @param camera The camera to use for rendering\r\n     * @param size This parameter can be set to a single number or to an object with the\r\n     * following (optional) properties: precision, width, height. If a single number is passed,\r\n     * it will be used for both width and height. If an object is passed, the screenshot size\r\n     * will be derived from the parameters. The precision property is a multiplier allowing\r\n     * rendering at a higher or lower resolution\r\n     * @param successCallback The callback receives a single parameter which contains the\r\n     * screenshot as a string of base64-encoded characters. This string can be assigned to the\r\n     * src parameter of an <img> to display it\r\n     * @param mimeType The MIME type of the screenshot image (default: image/png).\r\n     * Check your browser for supported MIME types\r\n     * @param samples Texture samples (default: 1)\r\n     * @param antialiasing Whether antialiasing should be turned on or not (default: false)\r\n     * @param fileName A name for for the downloaded file.\r\n     */\r\n    public static CreateScreenshotUsingRenderTarget(engine: Engine, camera: Camera, size: any, successCallback?: (data: string) => void, mimeType: string = \"image/png\", samples: number = 1, antialiasing: boolean = false, fileName?: string): void {\r\n        var width: number;\r\n        var height: number;\r\n\r\n        //If a precision value is specified\r\n        if (size.precision) {\r\n            width = Math.round(engine.getRenderWidth() * size.precision);\r\n            height = Math.round(width / engine.getAspectRatio(camera));\r\n            size = { width: width, height: height };\r\n        }\r\n        else if (size.width && size.height) {\r\n            width = size.width;\r\n            height = size.height;\r\n        }\r\n        //If passing only width, computing height to keep display canvas ratio.\r\n        else if (size.width && !size.height) {\r\n            width = size.width;\r\n            height = Math.round(width / engine.getAspectRatio(camera));\r\n            size = { width: width, height: height };\r\n        }\r\n        //If passing only height, computing width to keep display canvas ratio.\r\n        else if (size.height && !size.width) {\r\n            height = size.height;\r\n            width = Math.round(height * engine.getAspectRatio(camera));\r\n            size = { width: width, height: height };\r\n        }\r\n        //Assuming here that \"size\" parameter is a number\r\n        else if (!isNaN(size)) {\r\n            height = size;\r\n            width = size;\r\n        }\r\n        else {\r\n            Logger.Error(\"Invalid 'size' parameter !\");\r\n            return;\r\n        }\r\n\r\n        var scene = camera.getScene();\r\n        var previousCamera: Nullable<Camera> = null;\r\n\r\n        if (scene.activeCamera !== camera) {\r\n            previousCamera = scene.activeCamera;\r\n            scene.activeCamera = camera;\r\n        }\r\n\r\n        var renderCanvas = engine.getRenderingCanvas();\r\n        if (!renderCanvas) {\r\n            Logger.Error(\"No rendering canvas found !\");\r\n            return;\r\n        }\r\n\r\n        var originalSize = { width: renderCanvas.width, height: renderCanvas.height };\r\n        engine.setSize(width, height);\r\n        scene.render();\r\n\r\n        // At this point size can be a number, or an object (according to engine.prototype.createRenderTargetTexture method)\r\n        var texture = new RenderTargetTexture(\"screenShot\", size, scene, false, false, Constants.TEXTURETYPE_UNSIGNED_INT, false, Texture.NEAREST_SAMPLINGMODE);\r\n        texture.renderList = null;\r\n        texture.samples = samples;\r\n        if (antialiasing) {\r\n            texture.addPostProcess(new FxaaPostProcess('antialiasing', 1.0, scene.activeCamera));\r\n        }\r\n        texture.onAfterRenderObservable.add(() => {\r\n            Tools.DumpFramebuffer(width, height, engine, successCallback, mimeType, fileName);\r\n        });\r\n\r\n        scene.incrementRenderId();\r\n        scene.resetCachedMaterial();\r\n        texture.render(true);\r\n        texture.dispose();\r\n\r\n        if (previousCamera) {\r\n            scene.activeCamera = previousCamera;\r\n        }\r\n        engine.setSize(originalSize.width, originalSize.height);\r\n        camera.getProjectionMatrix(true); // Force cache refresh;\r\n    }\r\n}\r\n\r\nTools.CreateScreenshot = ScreenshotTools.CreateScreenshot;\r\nTools.CreateScreenshotUsingRenderTarget = ScreenshotTools.CreateScreenshotUsingRenderTarget;"]}